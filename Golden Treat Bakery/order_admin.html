<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Order Management - Admin ui</title>
  <link rel="stylesheet" href="css/admin_style.css">
  <link rel="stylesheet" href="">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

  </style>
</head>
<body>
  <div class="header">
    <div class="header-left">
      <img src="Resourses\logo.jpg" alt="Golden Treat Bakery" style="width:60px;height:auto;border-radius:8px;">
    </div>

    <div class="header-middle">
      <div class="header-middle-title">Order Management</div>
      <div class="search-bar" style="max-width:420px;">
        <input id="globalSearch" type="text" placeholder="Search orders by ID, customer or phone..." />
      </div>
    </div>

    <div class="header-right">
      <button class="role-btn" onclick="toggleRole()">Manager</button>
      <div class="user-icon"></div>
    </div>
  </div>

  <div class="layout">
    <div class="sidebar">
      <h1>Dashboard</h1>

      <nav>
        <button class="salesbtn">Orders</button>

        <div style="margin-top:14px; display:flex; flex-direction:column; gap:8px;">
          <button onclick="showContent('orders')" class="Sbtn">Order Management</button>
          <button onclick="showContent('inventory')" class="Ubtn">Inventory</button>
          <button onclick="showContent('users')" class="Bbtn">Users</button>
        </div>

        <hr>
        <p>Order Actions</p>
        <div class="salebtn">
          <button onclick="exportCsv()">Export CSV</button>
          <button onclick="showContent('report')">Generate Report</button>
        </div>
      </nav>
    </div>

    <div class="content" style="min-height:600px;">
      <!-- ORDERS PANEL -->
      <div id="ordersPanel" class="card">
        <h3>Orders</h3>

        <div class="controls" style="margin-top:8px;">
          <div class="field">
            <label class="small-muted" for="filterStatus">Status</label>
            <select id="filterStatus">
              <option value="">All</option>
              <option value="pending">Pending</option>
              <option value="packed">Packed</option>
              <option value="shipped">Shipped</option>
              <option value="out_for_delivery">Out for Delivery</option>
              <option value="delivered">Delivered</option>
              <option value="cancelled">Cancelled</option>
            </select>
          </div>

          <div class="field">
            <label class="small-muted" for="fromDate">From</label>
            <input id="fromDate" type="date">
          </div>

          <div class="field">
            <label class="small-muted" for="toDate">To</label>
            <input id="toDate" type="date">
          </div>

          <div class="field">
            <label class="small-muted" for="perPage">Per page</label>
            <select id="perPage"><option>8</option><option>12</option><option>20</option></select>
          </div>

          <div style="margin-left:auto; display:flex; gap:8px;">
            <button id="btnRefresh" class="btn-small" title="Reload orders">Refresh</button>
            <button id="btnClearFilters" class="btn-small" title="Clear filters">Clear</button>
          </div>
        </div>

        <div style="overflow:auto;">
          <table class="orders-table" aria-live="polite">
            <thead>
              <tr>
                <th>Order ID</th>
                <th>Customer</th>
                <th>Date</th>
                <th>Total</th>
                <th>Payment</th>
                <th>Status</th>
                <th style="width:200px">Actions</th>
              </tr>
            </thead>
            <tbody id="ordersTbody">
              <!-- rows injected by JS -->
            </tbody>
          </table>
        </div>

        <div class="pagination" id="pagination"></div>
      </div>

      <!-- EMPTY / OTHER PANELS (hidden by showContent) -->
      <div id="inventoryPanel" class="card" style="display:none;">
        <h3>Inventory</h3>
        <p class="small-muted">Inventory management goes here.</p>
      </div>

      <div id="usersPanel" class="card" style="display:none;">
        <h3>Users</h3>
        <p class="small-muted">User management goes here.</p>
      </div>

    </div>
  </div>

  <!-- Footer (reuse group footer or simple) -->
  <div style="height:40px"></div>

  <!-- ---------- Modals ---------- -->
  <div id="modalBackdrop" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal-head">
        <div>
          <h4 id="modalTitle">Order</h4>
          <div id="modalSubtitle" class="small-muted">Order details</div>
        </div>
        <div>
          <button id="modalClose" class="btn-small">Close</button>
        </div>
      </div>

      <div class="modal-body" id="modalBody">
        <!-- dynamic -->
      </div>

      <div class="modal-actions">
        <button id="modalSave" class="btn-small btn-approve" style="display:none">Save</button>
        <button id="modalApprove" class="btn-small btn-approve">Approve</button>
        <button id="modalCancelOrder" class="btn-small btn-cancel">Cancel Order</button>
      </div>
    </div>
  </div>
         <!----Chatgpt--->
  <script>
    // ---------- Demo data (replace with backend fetch) ----------
    const DEMO_ORDERS = [
      { order_id: 'TSH-20250815-001', customer: 'Haritha', phone: '+94771234567', date: '2025-08-15T10:05:00', total: 1400, payment: 'Card', status: 'pending', items: [{title:'Beef Burger',qty:1,price:850},{title:'Fries',qty:1,price:350}], note:'' },
      { order_id: 'TSH-20250710-009', customer: 'Nimal', phone: '+94771234568', date: '2025-07-10T12:10:00', total: 950, payment: 'COD', status: 'cancelled', items: [{title:'Fish & Rice',qty:1,price:950}], note:'' },
      { order_id: 'TSH-20250801-022', customer: 'Maya', phone: '+94771234569', date: '2025-08-01T09:30:00', total: 2200, payment: 'Card', status: 'delivered', items: [{title:'Party Pack',qty:2,price:1100}], note:'' },
      // more demo items for pagination:
      ...Array.from({length:24}).map((_,i)=>({
        order_id:`TSH-20250820-${100+i}`,
        customer:`Cust ${i+1}`,
        phone:`+94770000${100+i}`,
        date: new Date(Date.now() - (i*86400000)).toISOString(),
        total: (500 + (i*20)),
        payment: (i%2? 'Card':'COD'),
        status: (i%5 === 0 ? 'pending' : (i%5===1?'shipped':(i%5===2?'packed':(i%5===3?'out_for_delivery':'delivered')))),
        items:[{title:'Item A',qty:1,price:500}],
        note:''
      }))
    ];

    // ---------- State ----------
    let orders = DEMO_ORDERS.slice(); // will replace with backend fetch
    let currentPage = 1;
    let perPage = 8;
    let currentFilter = { status:'', from:'', to:'', q:'' };

    // ---------- DOM refs ----------
    const ordersTbody = document.getElementById('ordersTbody');
    const paginationEl = document.getElementById('pagination');
    const filterStatusEl = document.getElementById('filterStatus');
    const fromDateEl = document.getElementById('fromDate');
    const toDateEl = document.getElementById('toDate');
    const perPageEl = document.getElementById('perPage');
    const globalSearch = document.getElementById('globalSearch');
    const btnRefresh = document.getElementById('btnRefresh');
    const btnClearFilters = document.getElementById('btnClearFilters');

    // modal refs
    const modalBackdrop = document.getElementById('modalBackdrop');
    const modalBody = document.getElementById('modalBody');
    const modalTitle = document.getElementById('modalTitle');
    const modalSubtitle = document.getElementById('modalSubtitle');
    const modalClose = document.getElementById('modalClose');
    const modalApprove = document.getElementById('modalApprove');
    const modalCancelOrder = document.getElementById('modalCancelOrder');
    const modalSave = document.getElementById('modalSave');

    // ---------- Helper: format date ---------- 
    function prettyDate(ts){
      const d = new Date(ts);
      return d.toLocaleString();
    }

    // ---------- Render table ----------
    function renderTable(){
      perPage = parseInt(perPageEl.value,10) || 8;
      // Filtering
      const filtered = orders.filter(o => {
        if(currentFilter.status && o.status !== currentFilter.status) return false;
        if(currentFilter.from && new Date(o.date) < new Date(currentFilter.from)) return false;
        if(currentFilter.to && new Date(o.date) > new Date(currentFilter.to + 'T23:59:59')) return false;
        if(currentFilter.q){
          const q = currentFilter.q.toLowerCase();
          if(!(o.order_id.toLowerCase().includes(q) || (o.customer && o.customer.toLowerCase().includes(q)) || (o.phone && o.phone.toLowerCase().includes(q)))) return false;
        }
        return true;
      });

      const total = filtered.length;
      const pages = Math.max(1, Math.ceil(total / perPage));
      if(currentPage > pages) currentPage = pages;

      const start = (currentPage-1)*perPage;
      const pageItems = filtered.slice(start, start+perPage);

      ordersTbody.innerHTML = pageItems.map(o => `
        <tr>
          <td><strong>${o.order_id}</strong><div class="small-muted">${o.phone}</div></td>
          <td>${escapeHtml(o.customer)}</td>
          <td>${prettyDate(o.date)}</td>
          <td>LKR ${numberFormat(o.total)}</td>
          <td>${escapeHtml(o.payment)}</td>
          <td>${statusBadge(o.status)}</td>
          <td>
            <button class="btn-small btn-edit" data-id="${o.order_id}" onclick="openOrder('${o.order_id}')">View / Edit</button>
            <button class="btn-small btn-approve" data-id="${o.order_id}" onclick="approveOrder('${o.order_id}')">Approve</button>
            <button class="btn-small btn-cancel" data-id="${o.order_id}" onclick="cancelOrder('${o.order_id}')">Cancel</button>
          </td>
        </tr>
      `).join('') || `<tr><td colspan="7" style="text-align:center;padding:18px;color:#6b7280">No orders found</td></tr>`;

      renderPagination(pages, total);
    }

    function statusBadge(s){
      const human = s.replace(/_/g,' ').replace(/\b\w/g,ch=>ch.toUpperCase());
      const cls = s === 'pending' ? 'pending' : s === 'delivered' ? 'delivered' : s === 'cancelled' ? 'cancelled' : 'shipped';
      return `<span class="badge ${cls}">${human}</span>`;
    }

    function numberFormat(n){ return (n||0).toLocaleString('en-LK'); }
    function escapeHtml(s){ return (s||'').toString().replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    // ---------- Pagination UI ----------
    function renderPagination(pages, total){
      let html = `<div class="small-muted">Showing ${(currentPage-1)*perPage + 1} - ${Math.min(currentPage*perPage,total)} of ${total}</div>`;
      html += `<div style="margin-left:12px; display:flex; gap:6px;">`;
      html += `<button ${currentPage===1 ? 'disabled' : ''} onclick="gotoPage(1)">« First</button>`;
      html += `<button ${currentPage===1 ? 'disabled' : ''} onclick="gotoPage(${currentPage-1})">‹ Prev</button>`;
      html += `<div style="display:flex;align-items:center;padding:0 6px;">Page ${currentPage} / ${pages}</div>`;
      html += `<button ${currentPage===pages ? 'disabled' : ''} onclick="gotoPage(${currentPage+1})">Next ›</button>`;
      html += `<button ${currentPage===pages ? 'disabled' : ''} onclick="gotoPage(${pages})">Last »</button>`;
      html += `</div>`;
      paginationEl.innerHTML = html;
    }

    function gotoPage(n){ currentPage = Math.max(1, n); renderTable(); }

    // ---------- Actions ----------
    function openOrder(orderId){
      const o = orders.find(x => x.order_id === orderId);
      if(!o) return alert('Order not found');
      showModal(o);
    }

    function approveOrder(orderId){
      if(!confirm(`Mark ${orderId} as Approved / Shipped?`)) return;
      // TODO: call backend endpoint to update status e.g. PATCH /api/orders/:id {status:'shipped'}
      const o = orders.find(x => x.order_id === orderId);
      if(o){ o.status = 'shipped'; o.note = 'Approved by admin'; renderTable(); alert(`${orderId} updated (demo)`); }
    }

    function cancelOrder(orderId){
      if(!confirm(`Cancel order ${orderId}? This cannot be undone.`)) return;
      // TODO: call backend endpoint to cancel order
      const o = orders.find(x => x.order_id === orderId);
      if(o){ o.status = 'cancelled'; renderTable(); alert(`${orderId} cancelled (demo)`); }
    }

    // ---------- Modal ----------
    function showModal(order){
      modalBackdrop.style.display = 'flex';
      modalBackdrop.setAttribute('aria-hidden','false');
      modalTitle.textContent = `Order ${order.order_id}`;
      modalSubtitle.textContent = `Status: ${order.status.replace(/_/g,' ')}`;

      // Build modal body (items, summary, change status)
      const itemsHtml = (order.items || []).map(it=>`<tr><td>${escapeHtml(it.title)}</td><td style="text-align:center">${it.qty}</td><td style="text-align:right">LKR ${numberFormat(it.price * it.qty)}</td></tr>`).join('');
      modalBody.innerHTML = `
        <div style="display:flex;gap:18px;flex-wrap:wrap;">
          <div style="flex:1;min-width:260px;">
            <div><strong>Customer:</strong> ${escapeHtml(order.customer)}</div>
            <div><strong>Phone:</strong> ${escapeHtml(order.phone)}</div>
            <div><strong>Date:</strong> ${prettyDate(order.date)}</div>
            <div style="margin-top:8px"><strong>Payment:</strong> ${escapeHtml(order.payment)}</div>
          </div>

          <div style="flex:1;min-width:260px;">
            <div><strong>Items</strong></div>
            <table style="width:100%;border-collapse:collapse;margin-top:6px;">
              <thead><tr><th style="text-align:left">Item</th><th style="text-align:center">Qty</th><th style="text-align:right">Total</th></tr></thead>
              <tbody>${itemsHtml}</tbody>
              <tfoot><tr><td></td><td style="text-align:right"><strong>Total</strong></td><td style="text-align:right"><strong>LKR ${numberFormat(order.total)}</strong></td></tr></tfoot>
            </table>
          </div>
        </div>

        <div style="margin-top:12px;">
          <label class="small-muted">Change status</label>
          <select id="modalStatus" style="padding:8px;border-radius:6px;border:1px solid #ccc;margin-left:8px;">
            <option value="pending">Pending</option>
            <option value="packed">Packed</option>
            <option value="shipped">Shipped</option>
            <option value="out_for_delivery">Out for Delivery</option>
            <option value="delivered">Delivered</option>
            <option value="cancelled">Cancelled</option>
          </select>
        </div>

        <div style="margin-top:10px;">
          <label class="small-muted">Internal note</label>
          <textarea id="modalNote" rows="3" style="width:100%;padding:8px;margin-top:6px;border-radius:6px;border:1px solid #ccc">${escapeHtml(order.note||'')}</textarea>
        </div>
      `;

      // set current values
      document.getElementById('modalStatus').value = order.status;
      modalSave.style.display = 'inline-block';

      // handlers
      modalSave.onclick = async () => {
        const newStatus = document.getElementById('modalStatus').value;
        const note = document.getElementById('modalNote').value;
        // TODO: call backend endpoint: PATCH /api/orders/:order_id {status:newStatus,note:note}
        const idx = orders.findIndex(x => x.order_id === order.order_id);
        if(idx > -1){
          orders[idx].status = newStatus;
          orders[idx].note = note;
          renderTable();
          hideModal();
          alert('Order updated (demo). Replace with API call in production.');
        }
      };

      modalApprove.onclick = () => {
        approveOrder(order.order_id);
        hideModal();
      };
      modalCancelOrder.onclick = () => {
        if(confirm('Cancel this order?')){ cancelOrder(order.order_id); hideModal(); }
      };
    }

    function hideModal(){
      modalBackdrop.style.display = 'none';
      modalBackdrop.setAttribute('aria-hidden','true');
    }

    modalClose.addEventListener('click', hideModal);
    modalBackdrop.addEventListener('click', (e)=> { if(e.target === modalBackdrop) hideModal(); });

    // ---------- Filters & events ----------
    function applyFilters(){
      currentFilter.status = filterStatusEl.value;
      currentFilter.from = fromDateEl.value;
      currentFilter.to = toDateEl.value;
      currentFilter.q = globalSearch.value.trim();
      currentPage = 1;
      renderTable();
    }

    filterStatusEl.addEventListener('change', applyFilters);
    fromDateEl.addEventListener('change', applyFilters);
    toDateEl.addEventListener('change', applyFilters);
    perPageEl.addEventListener('change', ()=>{ currentPage=1; renderTable(); });
    globalSearch.addEventListener('input', ()=>{ currentFilter.q = globalSearch.value.trim(); currentPage=1; renderTable(); });
    btnRefresh.addEventListener('click', ()=> loadOrdersFromServer());
    btnClearFilters.addEventListener('click', ()=> {
      filterStatusEl.value=''; fromDateEl.value=''; toDateEl.value=''; globalSearch.value=''; currentFilter={status:'',from:'',to:'',q:''}; renderTable();
    });

    function gotoTop(){ window.scrollTo({top:0,behavior:'smooth'}); }

    // ---------- Data fetch (server integration) ----------
    async function loadOrdersFromServer(){
      // PRODUCTION: replace demo with actual fetch:
      // const resp = await fetch('/api/admin/orders?page='+currentPage+'&per_page='+perPage, {credentials:'same-origin'});
      // const json = await resp.json(); orders = json.orders; renderTable();

      // For demo we just re-use the in-memory orders
      renderTable();
      gotoTop();
    }

    // ---------- Utilities ----------
    function escapeParam(s){ return encodeURIComponent(s); }

    // export CSV (simple client-side)
    function exportCsv(){
      const rows = [['order_id','customer','phone','date','total','payment','status']];
      orders.forEach(o => rows.push([o.order_id,o.customer,o.phone,o.date,o.total,o.payment,o.status]));
      const csv = rows.map(r => r.map(c=>`"${(''+(c||'')).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'orders_export.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    // ---------- Helper: show other content (simple) ----------
    function showContent(name){
      document.getElementById('ordersPanel').style.display = name === 'orders' ? 'block' : 'none';
      document.getElementById('inventoryPanel').style.display = name === 'inventory' ? 'block' : 'none';
      document.getElementById('usersPanel').style.display = name === 'users' ? 'block' : 'none';
    }

    // ---------- small role toggle already in your template ----------
    let currentRole = "Manager";
    function toggleRole() {
      currentRole = currentRole === "Manager" ? "Admin" : "Manager";
      document.querySelector(".role-btn").innerText = currentRole;
    }

    // ---------- init ----------
    (function init(){
      // If you want to load from backend, call loadOrdersFromServer() here.
      renderTable();
    })();

    // Expose a few functions to inline onclicks
    window.openOrder = openOrder;
    window.approveOrder = approveOrder;
    window.cancelOrder = cancelOrder;
    window.showContent = showContent;
  </script>
</body>
</html>
